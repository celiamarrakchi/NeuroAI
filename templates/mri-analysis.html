<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRI Analysis - NeuroRadiology AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>
<body>
    <img id="originalPreview" style="display:none;">
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">
                <div class="logo-icon">üß†</div>
                NeuroRadiology AI
            </a>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/unified-analysis">Analysis</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>üî¨ Brain MRI Analysis System</h1>
            <p>AI-Powered Radiology Report Generation</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì§</div>
                <h3>Upload Brain MRI Scan</h3>
                <p>Drag and drop your MRI image here or click to browse</p>
                <p style="font-size: 0.9rem; color: #999;">Supported formats: JPG, JPEG, PNG</p>
                <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png">
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">Choose File</button>
            </div>
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
            <div class="preview-grid">
                <div class="preview-image">
                    <img id="previewImg" src="" alt="MRI Preview">
                </div>
                <div class="image-info">
                    <h3>üìã Image Information</h3>
                    <div class="info-item">
                        <span class="info-label">File Name:</span>
                        <span class="info-value" id="fileName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">File Size:</span>
                        <span class="info-value" id="fileSize">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Image Type:</span>
                        <span class="info-value" id="fileType">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" style="color: #28a745;">‚úì Ready for Analysis</span>
                    </div>
                </div>
            </div>
            <button class="analyze-button" id="startAnalysisBtn" onclick="startUnifiedAnalysis()">
                üöÄ Generate Radiology Report
            </button>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <h3 class="loading-text">Running AI Analysis...</h3>
                <ul class="loading-steps" id="loadingSteps">
                    <li>ü§ñ Medical Analysis - Evaluating MRI scan</li>
                    <li>‚è≥ Tumor Segmentation - Detecting and measuring</li>
                    <li>‚è≥ Explainability - Generating insights</li>
                    <li>‚è≥ Generating Professional Report with AI</li>
                </ul>
                <p style="margin-top: 1rem; color: #999; font-size: 0.9rem;">Please wait...</p>
            </div>
        </div>

        <div class="radiology-report" id="radiologyReport"></div>
        <button id="pdfDownloadBtn" class="pdf-download-btn">
            Download PDF Report
        </button>

    </div>

    <script>
        // ==========================================
        // CONFIGURATION - METTEZ VOTRE CL√â API ICI
        // ==========================================
         const API_KEY = '';  
        // ==========================================

        let selectedFile = null;
        let analysisResults = null;
        let professionalReport = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.match('image/(jpeg|jpg|png)')) {
                handleFile(files[0]);
            } else {
                showError('Veuillez t√©l√©charger un fichier JPG/JPEG/PNG');
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('originalPreview').src = e.target.result;
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
                document.getElementById('fileType').textContent = file.type.split('/')[1].toUpperCase();
                document.getElementById('previewSection').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

      async function generateProfessionalReport(jsonData) {

    const prompt = `
You are a senior neuro-oncology radiologist. 
Write a fully formatted, formal radiology report without using Markdown, without asterisks, without bold text, and without bullet points.
Use only plain text with section titles in uppercase.

Base your report on the following information:

Diagnosis: ${jsonData.medical_analysis.report.diagnosis}
Clinical Significance: ${jsonData.medical_analysis.report.clinical_significance}

ROI Findings:
${JSON.stringify(jsonData.medical_analysis.report.roi_findings, null, 2)}

The report must contain exactly the following sections:

MRI TECHNIQUE
Describe the MRI scanner strength and sequences (T1, T2, FLAIR, post-contrast).

FINDINGS
Describe:
- Tumor location
- Size of all ROI lesions
- Enhancement pattern
- Mass effect
- Edema
- Necrosis
- Infiltration pattern

CLINICAL INTERPRETATION
Summarize what the lesion most likely represents and the severity.

RECOMMENDATIONS
Provide clinically sound recommendations such as neurosurgical referral, biopsy, resection, multidisciplinary evaluation, and follow-up timing.

Rules:
- Do NOT use markdown.
- Do NOT use asterisks.
- Do NOT use lists or bullets; write full sentences and paragraphs only.
- Use formal radiology language.
- Maximum 4 paragraphs, one per section.
`;

    try {
        const response = await fetch("https://tokenfactory.esprit.tn/api/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: "hosted_vllm/Llama-3.1-70B-Instruct",
                messages: [
                    { role: "system", content: "You are an expert radiologist writing formal medical reports." },
                    { role: "user", content: prompt }
                ],
                max_tokens: 1800,
                temperature: 0.5
            })
        });

        const data = await response.json();
        const report = data.choices?.[0]?.message?.content;

        if (!report) throw new Error("No report generated");

        return report;

    } catch (error) {
        console.error("Error:", error);
        throw error;
    }
}

function formatMedicalReport(reportText, jsonData) {

    const explanation = jsonData.xai?.explanation || "No explanation available.";

    //const originalImg = jsonData.medical_analysis?.query_image || "";
    const originalImg = document.getElementById('originalPreview').src;

    const maskImg = jsonData.segmentation?.mask_base64 || "";
const reportDate = new Date().toLocaleDateString("en-US", {
    day: "2-digit",
    month: "short",
    year: "numeric",
});

    return `
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:wght@300;400;600&display=swap" rel="stylesheet">

        <div style="font-family: 'Roboto Serif', serif; padding: 30px; line-height: 1.6;">

            <!-- TITRE -->
            <h1 style="
                text-align: center;
                font-size: 32px;
                margin-bottom: 5px;
                color: #0d1b2a;
                font-weight: 600;
                letter-spacing: 1px;">
                Radiological Assessment Report ‚Äì Brain MRI
            </h1>
            <p style="text-align:center; margin-top:0; color:#4f5d75; font-size:14px;">
                Generated by Automated Neuro-Imaging Analysis System
            </p>
            <p style="text-align:center; margin-top:2px; color:#4f5d75; font-size:13px;">
                Date: ${reportDate}
            </p>

            
            <hr style="border:none; border-top:2px solid #d9d9d9; margin:25px 0;">

            <!-- PETIT RESUME -->
            <p style="text-align:justify; font-size:15px; color:#1e1e1e;">
                ${jsonData.medical_analysis.report.visual_summary}
            </p>

            <hr style="border:none; border-top:2px solid #d9d9d9; margin:20px 0;">

            <!-- VISUALISATION SECTION -->
            <h2 style="color:#1e4db7; font-size:22px;">VISUALISATION</h2>
            <hr style="border:none; border-top:1px solid #c7d2ff; margin-bottom:20px;">

            <!-- CONTENEUR FLEX -->
            <div style="display:flex; gap:20px; justify-content:center; align-items:flex-start;">

                <!-- IMAGE ORIGINALE -->
                <div style="flex:1; text-align:center;">
                    <h3 style="color:#274c77; margin-bottom:8px;">Original MRI</h3>
                    <img src="${originalImg}" class="mri-image" 
                        style="width:300px; height:300px; object-fit:contain; border-radius:10px; border:1px solid #ccc;">
                </div>

                <!-- IMAGE SEGMENTEE -->
                <div style="flex:1; text-align:center;">
                    <h3 style="color:#274c77; margin-bottom:8px;">Tumor Segmentation Mask</h3>
                    <img src="data:image/png;base64,${maskImg}" 
                        style="width:300px; height:300px; object-fit:contain; border-radius:10px; border:1px solid #ccc;">
                </div>

            </div>
             <hr style="border:none; border-top:1px solid #c7d2ff; margin-bottom:60px;">
             

            <!-- TABLEAU DES SEGMENTATIONS -->
            <div class="page-break"></div>
            <h3 style="margin-top:25px; color:#1e4db7; font-size:20px;">Regions of Interest</h3>
            
            <table style="width:100%; border-collapse:collapse; margin-top:10px; font-size:14px;">
                <thead>
                    <tr style="background:#eef2ff; color:#1e1e1e;">
                        <th style="border:1px solid #d0d0d0; padding:8px;">Region</th>
                        <th style="border:1px solid #d0d0d0; padding:8px;">Type</th>
                        <th style="border:1px solid #d0d0d0; padding:8px;">Size (mm)</th>
                        <th style="border:1px solid #d0d0d0; padding:8px;">Confidence</th>
                    </tr>
                </thead>
                <tbody>
                    ${jsonData.medical_analysis.report.roi_findings.map(roi => `
                        <tr>
                            <td style="border:1px solid #d0d0d0; padding:8px;">${roi.region}</td>
                            <td style="border:1px solid #d0d0d0; padding:8px;">${roi.type}</td>
                            <td style="border:1px solid #d0d0d0; padding:8px;">${roi.size_mm}</td>
                            <td style="border:1px solid #d0d0d0; padding:8px;">
                                ${(roi.confidence * 100).toFixed(1)}%
                            </td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>

            <!-- SECTION 1 -->
            <h2 style="color:#1e4db7; font-size:22px; margin-top:35px;">1. Tumor Segmentation</h2>
            <hr style="border:none; border-top:1px solid #c7d2ff;">
            <p>${jsonData.medical_analysis.report.visual_summary}</p>

            

            <!-- SECTION 3 -->
            <h2 style="color:#1e4db7; font-size:22px; margin-top:25px;">2. Explainability Summary</h2>
            <hr style="border:none; border-top:1px solid #c7d2ff;">
            <p style="white-space:pre-line;">${explanation}</p>

            <!-- SECTION 4 -->
            <h2 style="color:#1e4db7; font-size:22px; margin-top:25px;">3. Radiologist Interpretation</h2>
            <hr style="border:none; border-top:1px solid #c7d2ff;">
            <p style="white-space:pre-line; text-align:justify;">${reportText}</p>

        </div>
    `;
}

async function startUnifiedAnalysis() {
    if (!selectedFile) {
        showError("Veuillez s√©lectionner un fichier d'abord");
        return;
    }

    document.getElementById("loadingOverlay").style.display = "flex";

    const formData = new FormData();
    formData.append("image", selectedFile);

    try {
        const [analyzeRes, segmentRes] = await Promise.all([
            fetch("/api/analyze", { method: "POST", body: formData }),
            fetch("/api/segment", { method: "POST", body: formData })
        ]);

        const explainRes = await fetch("/api/explain", {
            method: "POST",
            body: formData
        });

        const analyzeData = await analyzeRes.json();
        const segmentData = await segmentRes.json();
        const explainData = await explainRes.json();

        const finalData = {
            success: analyzeData.success && segmentData.success && explainData.success,
            medical_analysis: analyzeData,
            segmentation: segmentData,
            xai: explainData,
            timestamp: new Date().toISOString()
        };

        if (!finalData.success) {
            showError("Erreur dans l'analyse m√©dicale");
            document.getElementById("loadingOverlay").style.display = "none";
            return;
        }

        analysisResults = finalData;

        document.getElementById("loadingSteps").innerHTML = `
            <li>‚úÖ Medical Analysis Completed</li>
            <li>‚úÖ Segmentation Completed</li>
            <li>‚úÖ Explainability Completed</li>
            <li>ü§ñ Generating radiologist report‚Ä¶</li>
        `;

        const reportText = await generateProfessionalReport(finalData);
        const html = formatMedicalReport(reportText, finalData);

        displayProfessionalReport(html);

    } catch (err) {
        console.error(err);
        showError("Erreur lors de l'analyse");
    }

    document.getElementById("loadingOverlay").style.display = "none";
}

      function displayProfessionalReport(html) {
    const container = document.getElementById("radiologyReport");
    container.innerHTML = html;
    container.classList.add("active");
}

        function downloadPDFReport() {
            if (!professionalReport) {
                showError('Aucun rapport disponible √† t√©l√©charger');
                return;
            }

            // Cr√©er un document texte format√© pour le rapport
            const reportText = professionalReport;
            const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Rapport_IRM_${new Date().getTime()}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function downloadJSONReport() {
            if (!analysisResults) {
                showError('No data available to download');
                return;
            }

            const dataStr = JSON.stringify(analysisResults, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Donnees_IRM_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    
    document.getElementById("pdfDownloadBtn").addEventListener("click", () => {
    const element = document.getElementById("radiologyReport");
    const options = {
        margin: 8,
        filename: "MRI_Report.pdf",
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };
    html2pdf().from(element).set(options).save();
});



    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</body>
</html>